name: Auto Rollback on Failure

on:
  workflow_run:
    workflows: ["CI Pipeline", "Release & Deploy"]
    types:
      - completed
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  rollback-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get failed workflow info
        id: workflow-info
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT

      - name: Find the merge commit to revert
        id: find-commit
        run: |
          FAILED_SHA="${{ github.event.workflow_run.head_sha }}"
          
          # Check if this is a merge commit
          PARENT_COUNT=$(git cat-file -p $FAILED_SHA | grep -c "^parent" || echo "1")
          
          if [ "$PARENT_COUNT" -gt 1 ]; then
            echo "This is a merge commit, will revert it"
            echo "commit_to_revert=$FAILED_SHA" >> $GITHUB_OUTPUT
            echo "is_merge=true" >> $GITHUB_OUTPUT
          else
            echo "This is not a merge commit, checking if it's from a PR"
            COMMIT_MSG=$(git log -1 --format=%s $FAILED_SHA)
            echo "Commit message: $COMMIT_MSG"
            echo "commit_to_revert=$FAILED_SHA" >> $GITHUB_OUTPUT
            echo "is_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Create rollback branch
        id: rollback
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          FAILED_SHA="${{ steps.find-commit.outputs.commit_to_revert }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ROLLBACK_BRANCH="rollback/auto-$TIMESTAMP"
          
          echo "Creating rollback branch: $ROLLBACK_BRANCH"
          git checkout -b $ROLLBACK_BRANCH
          
          if [ "${{ steps.find-commit.outputs.is_merge }}" == "true" ]; then
            git revert -m 1 $FAILED_SHA --no-edit || {
              echo "Revert failed, creating issue instead"
              echo "revert_failed=true" >> $GITHUB_OUTPUT
              exit 0
            }
          else
            git revert $FAILED_SHA --no-edit || {
              echo "Revert failed, creating issue instead"
              echo "revert_failed=true" >> $GITHUB_OUTPUT
              exit 0
            }
          fi
          
          git push origin $ROLLBACK_BRANCH
          echo "rollback_branch=$ROLLBACK_BRANCH" >> $GITHUB_OUTPUT
          echo "revert_failed=false" >> $GITHUB_OUTPUT

      - name: Create Rollback PR
        if: steps.rollback.outputs.revert_failed != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const rollbackBranch = '${{ steps.rollback.outputs.rollback_branch }}';
            const workflowName = '${{ steps.workflow-info.outputs.workflow_name }}';
            const runUrl = '${{ steps.workflow-info.outputs.run_url }}';
            const failedSha = '${{ steps.find-commit.outputs.commit_to_revert }}';
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® ROLLBACK: Revert failed commit from ${workflowName}`,
              head: rollbackBranch,
              base: 'main',
              body: `## ‚ö†Ô∏è Automatic Rollback PR\n\nThis PR was automatically created because the **${workflowName}** workflow failed on main branch.\n\n### Details\n- **Failed Workflow:** ${workflowName}\n- **Failed Run:** [View Workflow Run](${runUrl})\n- **Commit Being Reverted:** ${failedSha}\n\n### Action Required\n1. Review this rollback PR\n2. If the rollback is appropriate, merge it immediately\n3. Investigate the root cause of the failure\n4. Create a new PR with the fix\n\n---\n*This PR was automatically created by the Auto Rollback workflow.*`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['rollback', 'urgent', 'automated']
            });
            
            console.log(`Created rollback PR #${pr.data.number}`);

      - name: Create Issue if Revert Failed
        if: steps.rollback.outputs.revert_failed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const workflowName = '${{ steps.workflow-info.outputs.workflow_name }}';
            const runUrl = '${{ steps.workflow-info.outputs.run_url }}';
            const failedSha = '${{ steps.find-commit.outputs.commit_to_revert }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® URGENT: Manual rollback required - ${workflowName} failed`,
              body: `## ‚ö†Ô∏è Automatic Rollback Failed\n\nThe automatic rollback could not be completed due to conflicts.\n\n### Manual Action Required\n1. Investigate the failed workflow\n2. Manually revert commit \`${failedSha}\` if needed\n\n### Details\n- **Failed Workflow:** ${workflowName}\n- **Failed Run:** [View Workflow Run](${runUrl})\n- **Commit:** ${failedSha}\n\n### Commands to manually rollback:\n\`\`\`bash\ngit checkout main\ngit pull origin main\ngit revert ${failedSha}\ngit push origin main\n\`\`\`\n\n---\n*This issue was automatically created by the Auto Rollback workflow.*`,
              labels: ['rollback', 'urgent', 'needs-attention']
            });
