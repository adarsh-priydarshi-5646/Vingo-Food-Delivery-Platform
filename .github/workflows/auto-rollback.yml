# =============================================================================
# Auto Rollback - Automatic Rollback on Failed Deployments
# =============================================================================
# 
# Triggers: After CI Pipeline or Release workflow completes on main
# Action: Creates rollback PR if deployment fails
# Safety: Reverts to last known good commit automatically
# =============================================================================

name: Auto Rollback

on:
  workflow_run:
    workflows: ["CI Pipeline", "Release & Deploy"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  rollback:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main'
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Rollback
        id: rollback
        run: |
          FAILED_SHA="${{ github.event.workflow_run.head_sha }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH="rollback/auto-$TIMESTAMP"
          
          echo "Failed SHA: $FAILED_SHA"
          echo "Creating branch: $BRANCH"
          
          git checkout -b $BRANCH
          
          # Check if merge commit
          PARENT_COUNT=$(git cat-file -p $FAILED_SHA | grep -c "^parent" || echo "1")
          
          if [ "$PARENT_COUNT" -gt 1 ]; then
            git revert -m 1 $FAILED_SHA --no-edit || echo "revert_failed=true" >> $GITHUB_OUTPUT
          else
            git revert $FAILED_SHA --no-edit || echo "revert_failed=true" >> $GITHUB_OUTPUT
          fi
          
          if [ -z "$(git status --porcelain)" ]; then
            git push origin $BRANCH
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "sha=$FAILED_SHA" >> $GITHUB_OUTPUT
          else
            echo "revert_failed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR
        if: steps.rollback.outputs.revert_failed != 'true' && steps.rollback.outputs.branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.rollback.outputs.branch }}';
            const sha = '${{ steps.rollback.outputs.sha }}';
            const workflow = '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Rollback: Revert ${sha.substring(0,7)}`,
              head: branch,
              base: 'main',
              body: `## Auto Rollback\n\n**${workflow}** failed on main.\n\n- [Failed Run](${runUrl})\n- Reverting: \`${sha}\`\n\n**Merge immediately if rollback is needed.**`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['rollback', 'urgent']
            });
            
            console.log('Created PR #' + pr.data.number);

      - name: Create Issue if Failed
        if: steps.rollback.outputs.revert_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const workflow = '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Manual rollback needed - ${workflow} failed`,
              body: `## Auto Rollback Failed\n\nCould not auto-revert due to conflicts.\n\n- [Failed Run](${runUrl})\n- Commit: \`${sha}\`\n\n**Manual revert:**\n\`\`\`bash\ngit revert ${sha}\ngit push origin main\n\`\`\``,
              labels: ['rollback', 'urgent']
            });
