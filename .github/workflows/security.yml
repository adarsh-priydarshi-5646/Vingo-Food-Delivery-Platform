# =============================================================================
# Security Scan - Comprehensive Security Validation
# =============================================================================
#
# Triggers: Push to main, All PRs to main, Weekly schedule
#
# SECURITY CHECKS:
# âœ… Dependency Review - Block PRs with vulnerable new dependencies
# âœ… NPM Audit - Check for known vulnerabilities (critical = fail)
# âœ… Secret Scan - Detect leaked credentials/API keys
# âœ… SAST - Static Application Security Testing
#
# FAIL CONDITIONS:
# âŒ New dependency with high/critical vulnerability
# âŒ Critical npm vulnerability in existing packages
# âŒ Leaked secrets detected
# =============================================================================

name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ===========================================================================
  # DEPENDENCY REVIEW (PRs only)
  # ===========================================================================
  dependency-review:
    name: ğŸ“¦ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Review Dependencies
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  # ===========================================================================
  # NPM AUDIT
  # ===========================================================================
  npm-audit-frontend:
    name: ğŸ”’ Frontend Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
        working-directory: frontend

      - name: Security Audit
        run: |
          echo "ğŸ” Scanning frontend dependencies..."

          # Check for critical vulnerabilities (FAIL)
          if npm audit --audit-level=critical 2>&1 | grep -q "critical"; then
            echo "âŒ CRITICAL vulnerabilities found!"
            npm audit --audit-level=critical
            exit 1
          fi

          # Check for high vulnerabilities (WARNING)
          if npm audit --audit-level=high 2>&1 | grep -q "high"; then
            echo "âš ï¸ HIGH vulnerabilities found (warning)"
            npm audit --audit-level=high || true
          fi

          echo "âœ… No critical vulnerabilities in frontend"
        working-directory: frontend

  npm-audit-backend:
    name: ğŸ”’ Backend Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - run: npm ci
        working-directory: backend

      - name: Security Audit
        run: |
          echo "ğŸ” Scanning backend dependencies..."

          # Check for critical vulnerabilities (FAIL)
          if npm audit --audit-level=critical 2>&1 | grep -q "critical"; then
            echo "âŒ CRITICAL vulnerabilities found!"
            npm audit --audit-level=critical
            exit 1
          fi

          # Check for high vulnerabilities (WARNING)
          if npm audit --audit-level=high 2>&1 | grep -q "high"; then
            echo "âš ï¸ HIGH vulnerabilities found (warning)"
            npm audit --audit-level=high || true
          fi

          echo "âœ… No critical vulnerabilities in backend"
        working-directory: backend

  # ===========================================================================
  # SECRET SCANNING
  # ===========================================================================
  secret-scan:
    name: ğŸ”‘ Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Check for common secrets
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."

          # Patterns to check
          PATTERNS=(
            "sk_live_"
            "sk_test_[a-zA-Z0-9]{24}"
            "AKIA[0-9A-Z]{16}"
            "mongodb\+srv://[^:]+:[^@]+@"
            "-----BEGIN RSA PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
          )

          FOUND=false
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v ".env.example"; then
              echo "âš ï¸ Potential secret found matching: $pattern"
              FOUND=true
            fi
          done

          if [ "$FOUND" = true ]; then
            echo "âŒ Potential secrets detected - review required"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"

  # ===========================================================================
  # SECURITY STATUS
  # ===========================================================================
  security-status:
    name: âœ… Security Status
    needs: [npm-audit-frontend, npm-audit-backend, secret-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Evaluate Security
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         SECURITY SCAN RESULTS              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Frontend Audit: ${{ needs.npm-audit-frontend.result }}"
          echo "â•‘ Backend Audit:  ${{ needs.npm-audit-backend.result }}"
          echo "â•‘ Secret Scan:    ${{ needs.secret-scan.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          FAILED=false

          if [ "${{ needs.npm-audit-frontend.result }}" == "failure" ]; then
            echo "âŒ Frontend has critical vulnerabilities"
            FAILED=true
          fi

          if [ "${{ needs.npm-audit-backend.result }}" == "failure" ]; then
            echo "âŒ Backend has critical vulnerabilities"
            FAILED=true
          fi

          if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            echo "âŒ Secrets detected in codebase"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo ""
            echo "ğŸš« SECURITY SCAN FAILED"
            exit 1
          fi

          echo ""
          echo "âœ… SECURITY SCAN PASSED"
