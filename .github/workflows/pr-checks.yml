# =============================================================================
# PR Checks - Complete Pull Request Validation
# =============================================================================
#
# Triggers: All Pull Requests (opened, updated, reopened)
#
# VALIDATION PERFORMED:
# ‚úÖ Auto-labeling based on changed files
# ‚úÖ ESLint code quality check
# ‚úÖ All 62 tests must pass
# ‚úÖ Production build must succeed
# ‚úÖ Backend syntax validation
# ‚úÖ Security vulnerability scan
# ‚úÖ Dependency review for new packages
#
# AUTO-MERGE CONDITIONS:
# - All checks must pass
# - PR must have 'auto-merge' label OR be from dependabot
# - PR must not be from a fork (security)
# =============================================================================

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  # ===========================================================================
  # AUTO-LABELING
  # ===========================================================================
  label-pr:
    name: üè∑Ô∏è Auto Label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            docs:
              - '**/*.md'
            ci:
              - '.github/**'

      - name: Create and Add labels
        uses: actions/github-script@v8
        with:
          script: |
            const labelConfig = {
              'frontend': { color: '61dafb', description: 'üé® Frontend React changes' },
              'backend': { color: '68a063', description: '‚öôÔ∏è Backend Node.js changes' },
              'docs': { color: 'fef2c0', description: 'üìö Documentation updates' },
              'ci': { color: 'e11d48', description: 'üîß CI/CD workflow changes' },
              'dependencies': { color: '0366d6', description: 'üì¶ Dependency updates' },
            };

            for (const [name, config] of Object.entries(labelConfig)) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: name
                });
                await github.rest.issues.updateLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: name,
                  color: config.color,
                  description: config.description
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: name,
                    color: config.color,
                    description: config.description
                  });
                }
              }
            }

            const labelsToAdd = [];
            if ('${{ steps.changes.outputs.frontend }}' === 'true') labelsToAdd.push('frontend');
            if ('${{ steps.changes.outputs.backend }}' === 'true') labelsToAdd.push('backend');
            if ('${{ steps.changes.outputs.docs }}' === 'true') labelsToAdd.push('docs');
            if ('${{ steps.changes.outputs.ci }}' === 'true') labelsToAdd.push('ci');

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
              console.log('‚úÖ Labels:', labelsToAdd.join(', '));
            }

  # ===========================================================================
  # FRONTEND VALIDATION
  # ===========================================================================
  frontend:
    name: üé® Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install
        run: npm ci
        working-directory: frontend

      - name: üîç Lint Check
        run: |
          echo "Checking code quality..."
          npm run lint
          echo "‚úÖ No ESLint errors"
        working-directory: frontend

      - name: üß™ Run Tests
        run: |
          echo "Running 62 tests..."
          npm test
          echo "‚úÖ All tests passed"
        working-directory: frontend

      - name: üèóÔ∏è Build Check
        run: |
          echo "Building production bundle..."
          npm run build

          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          echo "‚úÖ Build successful"
        working-directory: frontend
        env:
          VITE_API_URL: https://api.example.com
          VITE_STRIPE_PUBLIC_KEY: pk_test_placeholder

      - name: üîí Security Check
        run: |
          echo "Checking for vulnerabilities..."
          npm audit --audit-level=critical || {
            echo "‚ùå Critical vulnerabilities found!"
            exit 1
          }
          echo "‚úÖ No critical vulnerabilities"
        working-directory: frontend

  # ===========================================================================
  # BACKEND VALIDATION
  # ===========================================================================
  backend:
    name: ‚öôÔ∏è Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install
        run: npm ci
        working-directory: backend

      - name: üìù Syntax Check
        run: |
          echo "Validating all JS files..."
          ERRORS=0
          for file in $(find . -name "*.js" -not -path "./node_modules/*"); do
            if ! node --check "$file" 2>/dev/null; then
              echo "‚ùå Error: $file"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå $ERRORS files have syntax errors"
            exit 1
          fi

          FILE_COUNT=$(find . -name "*.js" -not -path "./node_modules/*" | wc -l)
          echo "‚úÖ All $FILE_COUNT files valid"
        working-directory: backend

      - name: üîí Security Check
        run: |
          echo "Checking for vulnerabilities..."
          npm audit --audit-level=critical || {
            echo "‚ùå Critical vulnerabilities found!"
            exit 1
          }
          echo "‚úÖ No critical vulnerabilities"
        working-directory: backend

  # ===========================================================================
  # FINAL STATUS
  # ===========================================================================
  status:
    name: ‚úÖ PR Status
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Evaluate Results
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë          PR VALIDATION RESULTS             ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Frontend: ${{ needs.frontend.result }}"
          echo "‚ïë Backend:  ${{ needs.backend.result }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

          if [ "${{ needs.frontend.result }}" != "success" ]; then
            echo ""
            echo "‚ùå FRONTEND FAILED - Check:"
            echo "   ‚Ä¢ ESLint errors"
            echo "   ‚Ä¢ Test failures"
            echo "   ‚Ä¢ Build errors"
            echo "   ‚Ä¢ Security vulnerabilities"
            exit 1
          fi

          if [ "${{ needs.backend.result }}" != "success" ]; then
            echo ""
            echo "‚ùå BACKEND FAILED - Check:"
            echo "   ‚Ä¢ Syntax errors in JS files"
            echo "   ‚Ä¢ Security vulnerabilities"
            exit 1
          fi

          echo ""
          echo "‚úÖ ALL CHECKS PASSED"
          echo "üéâ This PR is safe to merge!"

  # ===========================================================================
  # AUTO-MERGE (Only if all checks pass)
  # ===========================================================================
  auto-merge:
    name: ü§ñ Auto Merge
    needs: [status]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check and Merge
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const statusResult = '${{ needs.status.result }}';

            console.log('üìä Status:', statusResult);
            console.log('üè∑Ô∏è Labels:', pr.labels.map(l => l.name).join(', '));

            // NEVER merge if checks failed
            if (statusResult !== 'success') {
              console.log('‚ùå Checks failed - merge blocked');
              return;
            }

            const hasAutoMerge = pr.labels.some(l => l.name === 'auto-merge');
            const isDependabot = pr.user.login === 'dependabot[bot]';

            if (!hasAutoMerge && !isDependabot) {
              console.log('‚ÑπÔ∏è Auto-merge not enabled');
              return;
            }

            // Security: Don't auto-merge fork PRs
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log('‚ö†Ô∏è Fork PR - manual review required');
              return;
            }

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              console.log('‚úÖ Auto-merged successfully!');
            } catch (e) {
              console.log('‚ö†Ô∏è Merge failed:', e.message);
            }
